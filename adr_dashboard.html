<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADR Dashboard - VigiFlow Data Analysis</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/common.css">
    
    <!-- Dashboard Specific CSS -->
    <style>
        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
            background-color: #f5f7fa;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-category {
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-category-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        .nav-category-header:hover {
            background: #e9ecef;
        }
        
        .nav-category-header i {
            transition: transform 0.3s ease;
        }
        
        .nav-category.active .nav-category-header i {
            transform: rotate(90deg);
        }
        
        .nav-items {
            display: none;
            background: white;
        }
        
        .nav-category.active .nav-items {
            display: block;
        }
        
        .nav-item {
            padding: 12px 20px 12px 40px;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #3498db;
            border-left-color: #3498db;
        }
        
        .nav-item.active {
            background: #e3f2fd;
            color: #2196f3;
            border-left-color: #2196f3;
            font-weight: 500;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        /* Global Filters */
        .global-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .filter-toggle {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 18px;
        }
        
        .filter-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-content select {
            max-width: 100%;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        /* Dashboard Overview */
        .dashboard-overview {
            display: grid;
            gap: 30px;
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-card h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-card .chart-container {
            position: relative;
            min-height: 300px;
        }
        
        /* Stat Cards */
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-card .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .stat-card .stat-content {
            flex: 1;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Visualization Content */
        .visualization-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .visualization-title {
            margin: 0;
            color: #333;
            font-size: 24px;
        }
        
        .visualization-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Mobile Responsive */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 90px;
            left: 10px;
            z-index: 1000;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 968px) {
            .dashboard-container {
                position: relative;
            }
            
            .sidebar {
                position: fixed;
                left: 0;
                top: 80px;
                height: calc(100vh - 80px);
                z-index: 999;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .main-content {
                padding: 20px;
                padding-top: 60px;
            }
            
            .overview-charts {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading State */
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: #6c757d;
        }
        
        /* Export Modal */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .export-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        
        .export-options {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-option {
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .export-option:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .export-option i {
            font-size: 24px;
            color: #3498db;
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table thead th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        .data-table tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1><i class="fas fa-chart-line"></i> ADR Dashboard</h1>
                <p>Comprehensive Adverse Drug Reaction Data Analysis</p>
            </div>
        </div>
    </header>

    <!-- Sidebar Toggle (Mobile) -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-th-large"></i> Visualizations</h3>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Overview -->
                <div class="nav-category active">
                    <div class="nav-category-header">
                        <span><i class="fas fa-home"></i> Overview</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item active" data-view="dashboard">Dashboard Overview</div>
                    </div>
                </div>
                
                <!-- Temporal Analysis -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-clock"></i> Temporal Analysis</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="received-date">Initial Received Date</div>
                        <div class="nav-item" data-view="onset-date">Reaction Onset Date</div>
                    </div>
                </div>
                
                <!-- Demographics -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-users"></i> Demographics</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="age-group">Age Group Analysis</div>
                        <div class="nav-item" data-view="sex">Sex Distribution</div>
                    </div>
                </div>
                
                <!-- Report Characteristics -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-file-medical"></i> Report Characteristics</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="report-types">Report Types</div>
                        <div class="nav-item" data-view="seriousness">Seriousness</div>
                        <div class="nav-item" data-view="serious-outcomes">Serious Outcomes</div>
                    </div>
                </div>
                
                <!-- Case Outcomes -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-heartbeat"></i> Case Outcomes</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="outcome">Patient Outcomes</div>
                    </div>
                </div>
                
                <!-- Drug Analysis -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-pills"></i> Drug Analysis</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="drug-who">WHO Drug Names</div>
                        <div class="nav-item" data-view="drug-reported">Reported Drug Names</div>
                    </div>
                </div>
                
                <!-- Special Populations -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-baby"></i> Special Populations</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="pregnancy">Pregnancy Status</div>
                        <div class="nav-item" data-view="lactation">Lactation Status</div>
                    </div>
                </div>
                
                <!-- Reporter Information -->
                <div class="nav-category">
                    <div class="nav-category-header">
                        <span><i class="fas fa-user-md"></i> Reporter Information</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="nav-items">
                        <div class="nav-item" data-view="qualification">Reporter Qualification</div>
                        <div class="nav-item" data-view="organization">Reporter Organization</div>
                        <div class="nav-item" data-view="action-taken">Action Taken</div>
                        <div class="nav-item" data-view="district">Reporter District</div>
                        <div class="nav-item" data-view="state-province">Reporter State/Province</div>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Upload Section (shown only when no data) -->
            <section class="upload-section" id="upload-section">
                <h2><i class="fas fa-file-excel"></i> Upload VigiFlow Excel File</h2>
                <div class="upload-area" id="upload-area" style="cursor: pointer;">
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <p class="upload-text">Drag and drop your Excel file here or click to browse</p>
                    <p class="upload-subtext">Supported formats: .xlsx, .xls</p>
                </div>
                <div id="file-info" style="margin-top: 1rem; display: none;">
                    <p>Selected file: <strong id="file-name"></strong></p>
                </div>
            </section>
            
            <!-- Global Filters (hidden until data loaded) -->
            <section class="global-filters" id="global-filters" style="display: none;">
                <div class="filter-header">
                    <h3><i class="fas fa-filter"></i> Global Filters</h3>
                    <button class="filter-toggle" id="filter-toggle">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="filter-content" id="filter-content">
                    <div class="filter-group">
                        <label>Date Range</label>
                        <input type="date" id="filter-start-date" placeholder="Start Date">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <input type="date" id="filter-end-date" placeholder="End Date">
                    </div>
                    <div class="filter-group">
                        <label>District/Province</label>
                        <select id="filter-location">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Drug Name</label>
                        <select id="filter-drug">
                            <option value="">All Drugs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Event/Outcome</label>
                        <select id="filter-outcome">
                            <option value="">All Outcomes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="apply-filters">
                            <i class="fas fa-check"></i> Apply Filters
                        </button>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" id="reset-filters">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Dynamic Content Area -->
            <div id="content-area">
                <!-- Content will be dynamically loaded here -->
            </div>
        </main>
    </div>
    
    <!-- Export Modal -->
    <div class="export-modal" id="export-modal">
        <div class="export-modal-content">
            <h3>Export Options</h3>
            <div class="export-options">
                <div class="export-option" data-export="pdf">
                    <i class="fas fa-file-pdf"></i>
                    <div>
                        <strong>PDF Report</strong>
                        <p style="margin: 0; font-size: 14px; color: #6c757d;">Export current view as PDF</p>
                    </div>
                </div>
                <div class="export-option" data-export="excel">
                    <i class="fas fa-file-excel"></i>
                    <div>
                        <strong>Excel Data</strong>
                        <p style="margin: 0; font-size: 14px; color: #6c757d;">Export filtered data to Excel</p>
                    </div>
                </div>
                <div class="export-option" data-export="image">
                    <i class="fas fa-image"></i>
                    <div>
                        <strong>Chart Image</strong>
                        <p style="margin: 0; font-size: 14px; color: #6c757d;">Download chart as PNG</p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="document.getElementById('export-modal').style.display='none'">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div class="message success" id="success-message" style="display: none;"></div>
    <div class="message error" id="error-message" style="display: none;"></div>
    
    <!-- Loading Spinner -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Processing data...</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="assets/js/common.js"></script>
    
    <script>
        // Global variables (originalData and filteredData are already declared in common.js)
        let currentView = 'dashboard';
        let charts = {};
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });
        
        function initializeDashboard() {
            console.log('[Dashboard] Initializing dashboard...');
            
            // Mark that we're setting up file upload to prevent common.js from doing it
            window.fileUploadInitialized = true;
            
            // Setup file upload with our processData callback
            setupFileUpload(processData);
            
            // Setup navigation
            setupNavigation();
            
            // Setup filters
            setupFilters();
            
            // Setup mobile sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Setup export modal
            setupExportModal();
            
            console.log('[Dashboard] Dashboard initialization complete');
        }
        
        // Process uploaded data
        function processData(data) {
            console.log('[Dashboard] ProcessData called with', data?.length || 0, 'rows');
            
            try {
                showLoading();
                
                // Validate data
                if (!data || !Array.isArray(data) || data.length === 0) {
                    throw new Error('No valid data found in the Excel file');
                }
                
                // Store raw data - data comes as array from common.js
                originalData = data;
                filteredData = [...originalData];
                
                console.log('[Dashboard] Data stored, sample row:', originalData[0]);
                
                // Hide upload section, show filters
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('global-filters').style.display = 'block';
                
                // Initialize date filters with data range
                console.log('[Dashboard] Initializing date filters...');
                initializeDateFilters();
                
                // Populate filter dropdowns
                console.log('[Dashboard] Populating filter dropdowns...');
                populateFilterDropdowns();
                
                // Show dashboard overview
                console.log('[Dashboard] Showing dashboard...');
                showDashboard();
                
                hideLoading();
                showSuccess(`Data loaded successfully! ${data.length} records found.`);
            } catch (error) {
                console.error('[Dashboard] Error in processData:', error);
                hideLoading();
                showError(`Error processing data: ${error.message}`);
                
                // Reset UI on error
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('global-filters').style.display = 'none';
            }
        }
        
        // Setup navigation
        function setupNavigation() {
            // Category toggles
            document.querySelectorAll('.nav-category-header').forEach(header => {
                header.addEventListener('click', function() {
                    const category = this.parentElement;
                    category.classList.toggle('active');
                });
            });
            
            // Navigation items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Update active states
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Load view
                    currentView = this.dataset.view;
                    loadView(currentView);
                    
                    // Close mobile sidebar
                    if (window.innerWidth <= 968) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });
        }
        
        // Setup filters
        function setupFilters() {
            // Filter toggle
            document.getElementById('filter-toggle').addEventListener('click', function() {
                const content = document.getElementById('filter-content');
                const icon = this.querySelector('i');
                
                if (content.style.display === 'none') {
                    content.style.display = 'grid';
                    icon.className = 'fas fa-chevron-up';
                } else {
                    content.style.display = 'none';
                    icon.className = 'fas fa-chevron-down';
                }
            });
            
            // Apply filters
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            
            // Reset filters
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }
        
        // Initialize date filters
        function initializeDateFilters() {
            try {
                if (!originalData || originalData.length === 0) {
                    console.log('[Dashboard] No data available for date filters');
                    return;
                }
                
                // Find date range from data
                let minDate = null;
                let maxDate = null;
                let validDates = 0;
                let invalidDates = 0;
                
                originalData.forEach((row, index) => {
                    const dateValue = row['Initial received date'];
                    if (dateValue) {
                        try {
                            // Use the parseInitialReceivedDate function from common.js
                            const d = parseInitialReceivedDate(dateValue);
                            if (d && !isNaN(d.getTime())) {
                                validDates++;
                                if (!minDate || d < minDate) minDate = d;
                                if (!maxDate || d > maxDate) maxDate = d;
                            } else {
                                invalidDates++;
                                console.warn(`[Dashboard] Invalid date at row ${index}: "${dateValue}"`);
                            }
                        } catch (e) {
                            invalidDates++;
                            console.error(`[Dashboard] Error parsing date at row ${index}: "${dateValue}"`, e);
                        }
                    }
                });
                
                console.log(`[Dashboard] Date parsing complete: ${validDates} valid, ${invalidDates} invalid`);
                
                if (minDate && maxDate) {
                    try {
                        // Extra validation before using toISOString
                        if (isNaN(minDate.getTime()) || isNaN(maxDate.getTime())) {
                            throw new Error('Invalid date objects after parsing');
                        }
                        
                        const minDateStr = minDate.toISOString().split('T')[0];
                        const maxDateStr = maxDate.toISOString().split('T')[0];
                        
                        document.getElementById('filter-start-date').min = minDateStr;
                        document.getElementById('filter-start-date').max = maxDateStr;
                        document.getElementById('filter-end-date').min = minDateStr;
                        document.getElementById('filter-end-date').max = maxDateStr;
                        
                        console.log(`[Dashboard] Date filters set: ${minDateStr} to ${maxDateStr}`);
                    } catch (e) {
                        console.error('[Dashboard] Error setting date filter bounds:', e);
                        console.error('[Dashboard] minDate:', minDate, 'maxDate:', maxDate);
                    }
                } else {
                    console.log('[Dashboard] No valid date range found for filters');
                }
            } catch (e) {
                console.error('[Dashboard] Critical error in initializeDateFilters:', e);
            }
        }
        
        // Helper function to parse drug names (for filtering)
        function parseDrugNames(drugValue) {
            if (!drugValue || drugValue === null || drugValue === undefined) {
                return [];
            }
            
            // Convert to string and clean Excel formatting
            let cleaned = drugValue.toString()
                .replace(/_x000D_/g, '\n')
                .replace(/\r/g, '\n')
                .trim();
            
            // Split by newlines and filter out empty values
            const drugs = cleaned.split('\n')
                .map(d => d.trim())
                .filter(d => d && d.length > 0);
            
            return drugs;
        }
        
        // Apply filters
        function applyFilters() {
            if (!originalData) return;
            
            showLoading();
            
            // Get filter values
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const location = document.getElementById('filter-location').value;
            const drug = document.getElementById('filter-drug').value;
            const outcome = document.getElementById('filter-outcome').value;
            
            // Filter data
            filteredData = originalData.filter(row => {
                // Date filter
                if (startDate || endDate) {
                    const dateValue = row['Initial received date'];
                    if (!dateValue) return false;
                    
                    const date = parseInitialReceivedDate(dateValue);
                    if (!date || isNaN(date.getTime())) return false;
                    
                    if (startDate && date < new Date(startDate)) return false;
                    if (endDate && date > new Date(endDate)) return false;
                }
                
                // Location filter (District or State/Province)
                if (location) {
                    const district = row['Reporter district'] || '';
                    const state = row['Reporter state or province'] || '';
                    if (!district.includes(location) && !state.includes(location)) return false;
                }
                
                // Drug filter (WHO standardized or Reported names)
                if (drug) {
                    let found = false;
                    
                    // Check WHO standardized drugs (primary)
                    const whoDrugs = row['Drug name (WHODrug)'];
                    if (whoDrugs) {
                        const drugs = parseDrugNames(whoDrugs);
                        if (drugs.some(d => d.toLowerCase().includes(drug.toLowerCase()))) {
                            found = true;
                        }
                    }
                    
                    // Check reported drugs (secondary)
                    if (!found) {
                        const reportedDrugs = row['Drug name as reported by initial reporter'];
                        if (reportedDrugs) {
                            const drugs = parseDrugNames(reportedDrugs);
                            if (drugs.some(d => d.toLowerCase().includes(drug.toLowerCase()))) {
                                found = true;
                            }
                        }
                    }
                    
                    if (!found) return false;
                }
                
                // Outcome filter - use cleaned value for comparison
                if (outcome) {
                    const rawOutcome = row['Outcome'];
                    const cleanedOutcome = cleanOutcomeValue(rawOutcome);
                    if (cleanedOutcome !== outcome) return false;
                }
                
                return true;
            });
            
            // Reload current view
            loadView(currentView);
            
            hideLoading();
            showSuccess(`Filters applied. Showing ${filteredData.length} of ${originalData.length} records.`);
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-drug').value = '';
            document.getElementById('filter-outcome').value = '';
            
            filteredData = [...originalData];
            loadView(currentView);
            showSuccess('Filters reset.');
        }
        
        // Clean outcome value - based on adr_outcome.html logic
        function cleanOutcomeValue(value) {
            if (!value || value === null || value === undefined) {
                return 'Unknown';
            }
            
            // Convert to string and clean
            let cleaned = value.toString()
                .replace(/_x000D_/g, ' ')
                .replace(/\r/g, ' ')
                .replace(/\n/g, ' ')
                .trim();
            
            // Check if it's just whitespace or empty
            if (cleaned === '' || cleaned === '_' || cleaned.length === 0) {
                return 'Unknown';
            }
            
            // Normalize to lowercase for matching
            const normalizedValue = cleaned.toLowerCase();
            
            // Handle repeated values (e.g., "Unknown Unknown Unknown")
            // First, check for duplicated words
            const words = normalizedValue.split(/\s+/);
            const uniqueWords = [...new Set(words)];
            
            // If all words are the same (e.g., "unknown unknown unknown"), use just one
            if (uniqueWords.length === 1 && words.length > 1) {
                const singleWord = uniqueWords[0];
                
                // Map common single words to standard outcomes
                if (singleWord === 'unknown' || singleWord === 'unkown') {
                    return 'Unknown';
                } else if (singleWord === 'fatal' || singleWord === 'died' || singleWord === 'death') {
                    return 'Died';
                } else if (singleWord === 'recovered' || singleWord === 'resolved') {
                    return 'Recovered';
                } else if (singleWord === 'recovering' || singleWord === 'resolving') {
                    return 'Recovering';
                }
            }
            
            // Handle variations with slashes (e.g., "Recovering / Resolving")
            if (normalizedValue.includes('/')) {
                // Check for common patterns
                if (normalizedValue.includes('recovering') || normalizedValue.includes('resolving')) {
                    return 'Recovering';
                } else if (normalizedValue.includes('recovered') || normalizedValue.includes('resolved')) {
                    // Check if it includes sequelae
                    if (normalizedValue.includes('sequelae')) {
                        return 'Recovered with sequelae';
                    }
                    return 'Recovered';
                }
            }
            
            // Handle specific outcome patterns
            if (normalizedValue.includes('unknown') || normalizedValue.includes('unkown')) {
                return 'Unknown';
            } else if (normalizedValue.includes('fatal') || normalizedValue.includes('died') || normalizedValue.includes('death')) {
                return 'Died';
            } else if ((normalizedValue.includes('recovered') || normalizedValue.includes('resolved')) && normalizedValue.includes('sequelae')) {
                return 'Recovered with sequelae';
            } else if (normalizedValue.includes('recovered') || normalizedValue.includes('resolved')) {
                return 'Recovered';
            } else if (normalizedValue.includes('recovering') || normalizedValue.includes('resolving')) {
                return 'Recovering';
            } else if (normalizedValue.includes('not recovered') || normalizedValue.includes('not resolved')) {
                return 'Not recovered';
            }
            
            // If no match found, check if it's a misspelling or variation
            // Common misspellings
            if (normalizedValue === 'unkown' || normalizedValue === 'unknow' || normalizedValue === 'unknwon') {
                return 'Unknown';
            }
            
            // If still no match, return Unknown for unrecognized values
            console.warn(`Unrecognized outcome value: "${cleaned}"`);
            return 'Unknown';
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            if (!originalData || originalData.length === 0) return;
            
            // Populate location filter (districts and states)
            const locationSet = new Set();
            originalData.forEach(row => {
                const district = row['Reporter district'];
                const state = row['Reporter state or province'];
                if (district && district.trim()) locationSet.add(district.trim());
                if (state && state.trim()) locationSet.add(state.trim());
            });
            
            const locationSelect = document.getElementById('filter-location');
            locationSelect.innerHTML = '<option value="">All Locations</option>';
            Array.from(locationSet).sort().forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
            
            // Populate drug filter (top 50 drugs)
            const drugCounts = {};
            
            // Helper function to parse drug names
            function parseDrugNames(drugValue) {
                if (!drugValue || drugValue === null || drugValue === undefined) {
                    return [];
                }
                
                // Convert to string and clean Excel formatting
                let cleaned = drugValue.toString()
                    .replace(/_x000D_/g, '\n')
                    .replace(/\r/g, '\n')
                    .trim();
                
                // Split by newlines and filter out empty values
                const drugs = cleaned.split('\n')
                    .map(d => d.trim())
                    .filter(d => d && d.length > 0);
                
                return drugs;
            }
            
            originalData.forEach(row => {
                // Count WHO standardized drugs (primary source)
                const whoDrugs = row['Drug name (WHODrug)'];
                if (whoDrugs) {
                    const drugs = parseDrugNames(whoDrugs);
                    drugs.forEach(drug => {
                        // Mark WHO drugs with (WHO) suffix for clarity
                        const drugKey = drug;
                        drugCounts[drugKey] = (drugCounts[drugKey] || 0) + 1;
                    });
                }
                
                // Count reported drugs (secondary source - to catch variations)
                const reportedDrugs = row['Drug name as reported by initial reporter'];
                if (reportedDrugs) {
                    const drugs = parseDrugNames(reportedDrugs);
                    drugs.forEach(drug => {
                        // Only add if not already in WHO drugs
                        if (!drugCounts[drug]) {
                            drugCounts[drug] = (drugCounts[drug] || 0) + 1;
                        } else {
                            // Increment count if already exists
                            drugCounts[drug]++;
                        }
                    });
                }
            });
            
            const drugSelect = document.getElementById('filter-drug');
            drugSelect.innerHTML = '<option value="">All Drugs</option>';
            Object.entries(drugCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50)
                .forEach(([drug, count]) => {
                    const option = document.createElement('option');
                    option.value = drug;
                    option.textContent = `${drug} (${count})`;
                    drugSelect.appendChild(option);
                });
            
            // Populate outcome filter using the standardized outcomes
            const outcomeOrder = ['Recovered', 'Recovering', 'Recovered with sequelae', 'Not recovered', 'Died', 'Unknown'];
            const outcomeCounts = {};
            
            // Initialize counts
            outcomeOrder.forEach(outcome => {
                outcomeCounts[outcome] = 0;
            });
            
            // Count cleaned outcomes
            originalData.forEach(row => {
                const rawOutcome = row['Outcome'];
                const cleanedOutcome = cleanOutcomeValue(rawOutcome);
                outcomeCounts[cleanedOutcome]++;
            });
            
            const outcomeSelect = document.getElementById('filter-outcome');
            outcomeSelect.innerHTML = '<option value="">All Outcomes</option>';
            
            // Add outcomes in order, showing count
            outcomeOrder.forEach(outcome => {
                if (outcomeCounts[outcome] > 0) {
                    const option = document.createElement('option');
                    option.value = outcome;
                    option.textContent = `${outcome} (${outcomeCounts[outcome]})`;
                    outcomeSelect.appendChild(option);
                }
            });
        }
        
        // Load view based on selection
        function loadView(view) {
            if (!filteredData) {
                showError('Please upload data first');
                return;
            }
            
            // Clean up existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            const contentArea = document.getElementById('content-area');
            
            switch(view) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'received-date':
                    showTemporalAnalysis('received');
                    break;
                case 'onset-date':
                    showTemporalAnalysis('onset');
                    break;
                case 'age-group':
                    showAgeGroupAnalysis();
                    break;
                case 'sex':
                    showSexDistribution();
                    break;
                case 'report-types':
                    showReportTypes();
                    break;
                case 'seriousness':
                    showSeriousness();
                    break;
                case 'serious-outcomes':
                    showSeriousOutcomes();
                    break;
                case 'outcome':
                    showPatientOutcomes();
                    break;
                case 'drug-who':
                    showDrugAnalysis('who');
                    break;
                case 'drug-reported':
                    showDrugAnalysis('reported');
                    break;
                case 'pregnancy':
                    showPregnancyStatus();
                    break;
                case 'lactation':
                    showLactationStatus();
                    break;
                case 'qualification':
                    showReporterQualification();
                    break;
                case 'organization':
                    showReporterOrganization();
                    break;
                case 'action-taken':
                    showActionTaken();
                    break;
                case 'district':
                    showGeographic('district');
                    break;
                case 'state-province':
                    showGeographic('state');
                    break;
                default:
                    showDashboard();
            }
        }
        
        // Show dashboard overview
        function showDashboard() {
            const contentArea = document.getElementById('content-area');
            
            // Calculate summary statistics
            const totalReports = filteredData.length;
            const seriousReports = filteredData.filter(row => row['Serious'] === 'Yes').length;
            
            // Calculate unique drugs using the same logic as adr_drug_analysis.html
            const drugCasesData = {};
            filteredData.forEach(row => {
                const drugs = parseDrugNames(row['Drug name (WHODrug)']);
                // Get unique drugs per case
                const uniqueDrugsInCase = [...new Set(drugs)];
                uniqueDrugsInCase.forEach(drug => {
                    drugCasesData[drug] = (drugCasesData[drug] || 0) + 1;
                });
            });
            const uniqueDrugs = Object.keys(drugCasesData).length;
            
            // Get date range
            let dateRange = 'N/A';
            const dates = filteredData
                .map(row => {
                    const dateValue = row['Initial received date'];
                    return dateValue ? parseInitialReceivedDate(dateValue) : null;
                })
                .filter(d => d && !isNaN(d.getTime()));
            
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                dateRange = `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`;
            }
            
            contentArea.innerHTML = `
                <div class="dashboard-overview">
                    <h2 style="margin: 0 0 30px 0; color: #333;">Dashboard Overview</h2>
                    
                    <!-- Summary Stats -->
                    <div class="overview-stats">
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #3498db">
                                <i class="fas fa-file-medical"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${totalReports.toLocaleString()}</div>
                                <div class="stat-label">Total ADR Reports</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #e74c3c">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${seriousReports.toLocaleString()}</div>
                                <div class="stat-label">Serious ADRs</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #9b59b6">
                                <i class="fas fa-pills"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${uniqueDrugs.toLocaleString()}</div>
                                <div class="stat-label">Unique Drugs</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #27ae60">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" style="font-size: 16px;">${dateRange}</div>
                                <div class="stat-label">Date Range</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Overview Charts -->
                    <div class="overview-charts">
                        <div class="chart-card">
                            <h4><i class="fas fa-chart-line"></i> ADR Reports Over Time</h4>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="trend-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4><i class="fas fa-pills"></i> Top 5 Reported Drugs</h4>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="drugs-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4><i class="fas fa-exclamation-circle"></i> Seriousness Distribution</h4>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="seriousness-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4><i class="fas fa-users"></i> Age Distribution</h4>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="age-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create charts
            setTimeout(() => {
                createTrendChart();
                createTopDrugsChart();
                createSeriousnessChart();
                createAgeChart();
            }, 100);
        }
        
        // Create trend chart
        function createTrendChart() {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            // Process data by month using proper date parsing
            const monthlyData = {};
            let validDates = 0;
            
            filteredData.forEach(row => {
                const dateValue = row['Initial received date'];
                if (dateValue) {
                    const date = parseInitialReceivedDate(dateValue);
                    if (date && !isNaN(date.getTime())) {
                        validDates++;
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                    }
                }
            });
            
            // Sort months and prepare data
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                return new Date(year, monthNum - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            });
            const values = sortedMonths.map(month => monthlyData[month]);
            
            // Check if we have data
            if (sortedMonths.length === 0) {
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText('No data available for the selected date range', ctx.canvas.width / 2, ctx.canvas.height / 2);
                console.log('[Dashboard] No monthly data available for trend chart');
                return;
            }
            
            console.log(`[Dashboard] Creating trend chart with ${sortedMonths.length} months, ${validDates} valid dates`);
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ADR Reports',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'ADR Reports Over Time',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Create top drugs chart
        function createTopDrugsChart() {
            const ctx = document.getElementById('drugs-chart').getContext('2d');
            
            // Count drugs using WHO standardized names (cases count, not mentions)
            const drugCounts = {};
            filteredData.forEach(row => {
                const drugField = row['Drug name (WHODrug)'];
                if (drugField) {
                    // Parse drugs using the same logic as filters
                    const drugs = parseDrugNames(drugField);
                    // Get unique drugs per case (same as adr_drug_analysis.html)
                    const uniqueDrugsInCase = [...new Set(drugs)];
                    uniqueDrugsInCase.forEach(drug => {
                        drugCounts[drug] = (drugCounts[drug] || 0) + 1;
                    });
                }
            });
            
            // Get top 5
            const topDrugs = Object.entries(drugCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Check if we have data
            if (topDrugs.length === 0) {
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText('No drug data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                console.log('[Dashboard] No drug data available for top drugs chart');
                return;
            }
            
            console.log(`[Dashboard] Creating top drugs chart with ${topDrugs.length} drugs`);
            
            charts.drugs = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topDrugs.map(d => {
                        // Truncate long drug names for display
                        const name = d[0];
                        return name.length > 30 ? name.substring(0, 30) + '...' : name;
                    }),
                    datasets: [{
                        label: 'Number of Reports',
                        data: topDrugs.map(d => d[1]),
                        backgroundColor: '#9b59b6',
                        borderColor: '#8e44ad',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 5 Reported Drugs',
                            font: { size: 14 }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Show full drug name in tooltip
                                    const index = context[0].dataIndex;
                                    return topDrugs[index][0];
                                },
                                label: function(context) {
                                    return `Reports: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // Create seriousness chart
        function createSeriousnessChart() {
            const ctx = document.getElementById('seriousness-chart').getContext('2d');
            
            // Count seriousness
            const serious = filteredData.filter(row => row['Serious'] === 'Yes').length;
            const nonSerious = filteredData.filter(row => row['Serious'] === 'No').length;
            const unknown = filteredData.length - serious - nonSerious;
            
            const data = [serious, nonSerious];
            const labels = ['Serious', 'Non-serious'];
            const colors = ['#e74c3c', '#27ae60'];
            
            if (unknown > 0) {
                data.push(unknown);
                labels.push('Unknown');
                colors.push('#95a5a6');
            }
            
            charts.seriousness = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Helper functions for age calculation
        function ageInYears(ageInDays) {
            return ageInDays / 365.25;
        }
        
        function getAgeGroup(ageInDays) {
            const ageYears = ageInYears(ageInDays);
            
            if (ageInDays <= 28) return 'Neonate (≤ 28 days)';
            if (ageInDays <= 365) return 'Infant (29 days - 1 year)';
            if (ageYears <= 12) return 'Child (1-12 years)';
            if (ageYears <= 17) return 'Adolescent (13-17 years)';
            if (ageYears <= 60) return 'Adult (18-60 years)';
            return 'Elderly (> 60 years)';
        }
        
        function parseAgeAtOnset(ageString) {
            if (!ageString) return null;
            
            const match = ageString.match(/(\d+\.?\d*)\s*(Year|Month|Week|Day|Hour)/i);
            if (!match) return null;
            
            const value = parseFloat(match[1]);
            const unit = match[2].toLowerCase();
            
            let ageInDays;
            switch(unit) {
                case 'year':
                    ageInDays = value * 365.25;
                    break;
                case 'month':
                    ageInDays = value * 30.44;
                    break;
                case 'week':
                    ageInDays = value * 7;
                    break;
                case 'day':
                    ageInDays = value;
                    break;
                case 'hour':
                    ageInDays = value / 24;
                    break;
                default:
                    return null;
            }
            
            return ageInDays;
        }
        
        function calculateAge(birthDate, receivedDate) {
            if (!birthDate || !receivedDate) return null;
            
            const diffTime = receivedDate - birthDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            
            return diffDays > 0 ? diffDays : null;
        }

        // Create age chart
        function createAgeChart() {
            const ctx = document.getElementById('age-chart').getContext('2d');
            
            // Process age groups with proper calculation
            const ageGroups = {
                'Neonate (≤ 28 days)': 0,
                'Infant (29 days - 1 year)': 0,
                'Child (1-12 years)': 0,
                'Adolescent (13-17 years)': 0,
                'Adult (18-60 years)': 0,
                'Elderly (> 60 years)': 0,
                'Unknown': 0
            };
            
            filteredData.forEach(row => {
                let ageInDays = null;
                
                // Try to calculate from birth date first
                if (row['Date of birth'] && row['Initial received date']) {
                    let birthDate = null;
                    const dobValue = row['Date of birth'];
                    
                    if (typeof dobValue === 'number' || /^\d{8}$/.test(dobValue.toString())) {
                        const dateStr = dobValue.toString();
                        const year = parseInt(dateStr.substring(0, 4));
                        const month = parseInt(dateStr.substring(4, 6));
                        const day = parseInt(dateStr.substring(6, 8));
                        
                        if (year >= 1900 && year <= 2030 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                            birthDate = new Date(year, month - 1, day);
                        }
                    }
                    
                    if (birthDate) {
                        const receivedDate = parseInitialReceivedDate(row['Initial received date']);
                        if (receivedDate) {
                            ageInDays = calculateAge(birthDate, receivedDate);
                        }
                    }
                }
                
                // If no age from dates, try Age at onset field
                if (!ageInDays && row['Age at onset of reaction']) {
                    ageInDays = parseAgeAtOnset(row['Age at onset of reaction']);
                }
                
                // Determine age group
                const group = ageInDays ? getAgeGroup(ageInDays) : 'Unknown';
                ageGroups[group]++;
            });
            
            // Prepare data for chart
            const labels = Object.keys(ageGroups);
            const data = Object.values(ageGroups);
            const colors = [
                'rgba(255, 99, 132, 0.8)',   // Neonate - Red
                'rgba(255, 159, 64, 0.8)',   // Infant - Orange
                'rgba(255, 205, 86, 0.8)',   // Child - Yellow
                'rgba(75, 192, 192, 0.8)',   // Adolescent - Teal
                'rgba(54, 162, 235, 0.8)',   // Adult - Blue
                'rgba(153, 102, 255, 0.8)',  // Elderly - Purple
                'rgba(201, 203, 207, 0.8)'   // Unknown - Gray
            ];
            
            charts.age = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return {
                                            text: value > 0 ? `${label}: ${value} (${percentage}%)` : label,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Show temporal analysis
        function showTemporalAnalysis(type) {
            const contentArea = document.getElementById('content-area');
            const title = type === 'received' ? 'ADR Reports by Initial Received Date' : 'ADR Reports by Reaction Onset Date';
            const dateField = type === 'received' ? 'Initial received date' : 'Onset date / Time';
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">${title}</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="temporal-chart"></canvas>
                    </div>
                    <div class="stats-grid" id="temporal-stats" style="margin-top: 20px;">
                        <!-- Stats will be populated here -->
                    </div>
                </div>
            `;
            
            // Create temporal chart
            setTimeout(() => {
                const ctx = document.getElementById('temporal-chart').getContext('2d');
                
                // Process data by month using proper date parsing
                const monthlyData = {};
                let validDates = 0;
                let invalidDates = 0;
                
                filteredData.forEach(row => {
                    const dateValue = row[dateField];
                    if (dateValue) {
                        const date = type === 'received' ? 
                            parseInitialReceivedDate(dateValue) : 
                            parseOnsetDate(dateValue);
                        
                        if (date && !isNaN(date.getTime())) {
                            validDates++;
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                        } else {
                            invalidDates++;
                        }
                    }
                });
                
                // Use the common.js function to get monthly data
                const monthlyDataByName = getMonthlyData(filteredData.map(row => {
                    const dateValue = row[dateField];
                    if (dateValue) {
                        const date = type === 'received' ? 
                            parseInitialReceivedDate(dateValue) : 
                            parseOnsetDate(dateValue);
                        return { ...row, _parsedDate: date };
                    }
                    return row;
                }), '_parsedDate');
                
                // Chart colors
                const colors = {
                    background: 'rgba(54, 162, 235, 0.7)',
                    border: 'rgba(54, 162, 235, 1)',
                    hoverBackground: 'rgba(54, 162, 235, 0.9)',
                    hoverBorder: 'rgba(54, 162, 235, 1)'
                };
                
                // Create new chart using common config
                const config = createBarChartConfig(monthlyDataByName, 'Number of ADR Reports', colors);
                charts.temporal = new Chart(ctx, config);
                
                // Update stats
                const statsGrid = document.getElementById('temporal-stats');
                statsGrid.innerHTML = '';
                
                // Total cases
                addStatCard(statsGrid, 'Total ADR Cases', filteredData.length);
                
                // Cases with valid dates
                addStatCard(statsGrid, 'Cases with Valid Dates', validDates);
                
                // Most active month
                const maxMonth = Object.entries(monthlyDataByName).sort((a, b) => b[1] - a[1])[0];
                if (maxMonth && maxMonth[1] > 0) {
                    addStatCard(statsGrid, 'Most Active Month', `${maxMonth[0]} (${maxMonth[1]} cases)`);
                }
                
                // Date range
                const dates = filteredData
                    .map(row => {
                        const dateValue = row[dateField];
                        return dateValue ? (type === 'received' ? 
                            parseInitialReceivedDate(dateValue) : 
                            parseOnsetDate(dateValue)) : null;
                    })
                    .filter(d => d && !isNaN(d.getTime()));
                
                if (dates.length > 0) {
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));
                    addStatCard(statsGrid, 'Date Range', 
                        `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`);
                }
            }, 100);
        }
        
        // Show age group analysis
        function showAgeGroupAnalysis() {
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Cases by Age Group</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="age-chart"></canvas>
                    </div>
                </div>
            `;
            
            // Create age group chart
            setTimeout(() => {
                const ctx = document.getElementById('age-chart').getContext('2d');
                
                // Count age groups
                const ageCounts = {};
                filteredData.forEach(row => {
                    const ageGroup = row['Age groups upon initial reaction'];
                    if (ageGroup) {
                        ageCounts[ageGroup] = (ageCounts[ageGroup] || 0) + 1;
                    }
                });
                
                const ageOrder = [
                    'Neonate', 'Infant', 'Child', 
                    'Adolescent', 'Adult', 'Elderly'
                ];
                
                const sortedData = ageOrder
                    .filter(age => ageCounts[age])
                    .map(age => ({ age, count: ageCounts[age] }));
                
                charts.age = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: sortedData.map(d => d.age),
                        datasets: [{
                            data: sortedData.map(d => d.count),
                            backgroundColor: [
                                '#FF6B6B', '#4ECDC4', '#45B7D1', 
                                '#96CEB4', '#FECA57', '#DDA0DD'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // Show sex distribution
        function showSexDistribution() {
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Cases by Sex</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="sex-chart"></canvas>
                    </div>
                </div>
            `;
            
            // Create sex chart
            setTimeout(() => {
                const ctx = document.getElementById('sex-chart').getContext('2d');
                
                // Count sex distribution
                const sexCounts = {};
                filteredData.forEach(row => {
                    const sex = row['Sex'] || 'Unknown';
                    sexCounts[sex] = (sexCounts[sex] || 0) + 1;
                });
                
                charts.sex = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(sexCounts),
                        datasets: [{
                            data: Object.values(sexCounts),
                            backgroundColor: ['#3498db', '#e74c3c', '#95a5a6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // Additional visualization functions would follow similar patterns...
        // For brevity, I'll include a few more examples
        
        // Show report types
        function showReportTypes() {
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Cases by Report Type</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="report-type-chart"></canvas>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const ctx = document.getElementById('report-type-chart').getContext('2d');
                
                // Count report types
                const typeCounts = {};
                filteredData.forEach(row => {
                    const type = row['Report Type'] || 'Unknown';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                
                charts.reportType = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(typeCounts),
                        datasets: [{
                            data: Object.values(typeCounts),
                            backgroundColor: [
                                '#3498db', '#e74c3c', '#f39c12', 
                                '#27ae60', '#9b59b6', '#1abc9c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // Setup export modal
        function setupExportModal() {
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', function() {
                    const exportType = this.dataset.export;
                    handleExport(exportType);
                    document.getElementById('export-modal').style.display = 'none';
                });
            });
        }
        
        // Show export modal
        function showExportModal() {
            document.getElementById('export-modal').style.display = 'flex';
        }
        
        // Handle export
        function handleExport(type) {
            switch(type) {
                case 'pdf':
                    exportToPDF();
                    break;
                case 'excel':
                    exportToExcel();
                    break;
                case 'image':
                    exportChartImage();
                    break;
            }
        }
        
        // Export to PDF
        function exportToPDF() {
            showSuccess('PDF export functionality would be implemented here');
        }
        
        // Export to Excel
        function exportToExcel() {
            showSuccess('Excel export functionality would be implemented here');
        }
        
        // Export chart image
        function exportChartImage() {
            showSuccess('Chart image export functionality would be implemented here');
        }
        
        // Show seriousness analysis
        function showSeriousness() {
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Cases by Seriousness</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="seriousness-detail-chart"></canvas>
                    </div>
                    <div class="data-table-container" style="margin-top: 20px;">
                        <h3>Seriousness Distribution</h3>
                        <table class="data-table" id="seriousness-table">
                            <thead>
                                <tr>
                                    <th>Seriousness</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const ctx = document.getElementById('seriousness-detail-chart').getContext('2d');
                
                // Clean serious value from Excel formatting issues
                function cleanSeriousValue(value) {
                    if (!value || value === null || value === undefined) {
                        return 'Unknown';
                    }
                    
                    // Convert to string and remove carriage returns and newlines
                    let cleaned = value.toString()
                        .replace(/_x000D_/g, '')
                        .replace(/\n/g, '')
                        .replace(/\r/g, '')
                        .trim();
                    
                    // Check if it's just whitespace or empty after cleaning
                    if (cleaned === '' || cleaned === '_' || cleaned.length === 0) {
                        return 'Unknown';
                    }
                    
                    // Extract Yes or No from repeated values (e.g., "NoNoNo" -> "No", "YesYes" -> "Yes")
                    if (cleaned.toLowerCase().includes('yes')) {
                        return 'Yes';
                    } else if (cleaned.toLowerCase().includes('no')) {
                        return 'No';
                    }
                    
                    return 'Unknown';
                }
                
                // Count seriousness categories
                const seriousnessCounts = {};
                
                filteredData.forEach(row => {
                    const seriousness = cleanSeriousValue(row['Serious']);
                    seriousnessCounts[seriousness] = (seriousnessCounts[seriousness] || 0) + 1;
                });
                
                // Prepare data for chart
                const labels = Object.keys(seriousnessCounts);
                const data = Object.values(seriousnessCounts);
                const total = data.reduce((a, b) => a + b, 0);
                
                // Define colors
                const seriousnessColors = {
                    'Yes': { background: 'rgba(231, 76, 60, 0.8)', border: 'rgba(231, 76, 60, 1)' },
                    'No': { background: 'rgba(46, 204, 113, 0.8)', border: 'rgba(46, 204, 113, 1)' },
                    'Unknown': { background: 'rgba(149, 165, 166, 0.8)', border: 'rgba(149, 165, 166, 1)' }
                };
                
                // Prepare colors
                const backgroundColors = labels.map(label => 
                    seriousnessColors[label]?.background || 'rgba(189, 195, 199, 0.8)'
                );
                const borderColors = labels.map(label => 
                    seriousnessColors[label]?.border || 'rgba(189, 195, 199, 1)'
                );
                
                charts.seriousnessDetail = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Total ADR Cases: ${total.toLocaleString()}`,
                                font: {
                                    size: 16,
                                    weight: 'normal'
                                },
                                padding: 20
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const dataset = data.datasets[0];
                                                const value = dataset.data[i];
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return {
                                                    text: `${label}: ${value} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    strokeStyle: dataset.borderColor[i],
                                                    lineWidth: dataset.borderWidth,
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label;
                                        const value = context.raw;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return [
                                            `${label}: ${value.toLocaleString()}`,
                                            `Percentage: ${percentage}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update data table
                const tbody = document.querySelector('#seriousness-table tbody');
                tbody.innerHTML = '';
                
                // Sort by count descending
                const sortedEntries = Object.entries(seriousnessCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                sortedEntries.forEach(([category, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${category}</td>
                        <td>${count.toLocaleString()}</td>
                        <td>${percentage}%</td>
                    `;
                });
            }, 100);
        }
        
        function showSeriousOutcomes() {
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Serious Outcomes Analysis</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="serious-outcomes-chart"></canvas>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const ctx = document.getElementById('serious-outcomes-chart').getContext('2d');
                
                // Define outcome categories
                const outcomeCategories = {
                    'Results in death': { 
                        order: 1, 
                        color: 'rgba(231, 76, 60, 0.9)' 
                    },
                    'Life threatening': { 
                        order: 2, 
                        color: 'rgba(230, 126, 34, 0.9)' 
                    },
                    'Caused/Prolonged hospitalization': { 
                        order: 3, 
                        color: 'rgba(155, 89, 182, 0.9)' 
                    },
                    'Disabling': { 
                        order: 4, 
                        color: 'rgba(52, 152, 219, 0.9)' 
                    },
                    'Congenital Anomaly': { 
                        order: 5, 
                        color: 'rgba(241, 196, 15, 0.9)' 
                    },
                    'Other Medically Important Condition': { 
                        order: 6, 
                        color: 'rgba(26, 188, 156, 0.9)' 
                    },
                    'Unknown / Not Serious': { 
                        order: 7, 
                        color: 'rgba(149, 165, 166, 0.8)' 
                    }
                };
                
                // Clean seriousness value
                function cleanSeriousnessValue(value) {
                    if (!value || value === null || value === undefined) {
                        return null;
                    }
                    
                    let cleaned = value.toString()
                        .replace(/_x000D_/g, '')
                        .replace(/\r/g, '')
                        .replace(/\n+/g, ' ')
                        .trim();
                    
                    if (cleaned === '' || cleaned === '_' || cleaned.length === 0) {
                        return null;
                    }
                    
                    // Remove duplicate phrases
                    cleaned = cleaned.replace(/Results in death\s*Results in death/gi, 'Results in death');
                    
                    return cleaned;
                }
                
                // Parse seriousness outcomes
                function parseSeriousnessOutcomes(value) {
                    const cleanedValue = cleanSeriousnessValue(value);
                    if (!cleanedValue) return [];
                    
                    const outcomes = [];
                    
                    // Check for each known outcome category
                    for (const category in outcomeCategories) {
                        if (cleanedValue.toLowerCase().includes(category.toLowerCase())) {
                            outcomes.push(category);
                        }
                    }
                    
                    return outcomes;
                }
                
                // Count outcomes
                const outcomesData = {};
                
                // Initialize outcome counts
                for (const category in outcomeCategories) {
                    outcomesData[category] = 0;
                }
                
                // Process each record
                filteredData.forEach(row => {
                    const outcomes = parseSeriousnessOutcomes(row['Seriousness (E2B)']);
                    
                    if (outcomes.length > 0) {
                        // Count individual outcomes
                        outcomes.forEach(outcome => {
                            outcomesData[outcome]++;
                        });
                    } else {
                        // Count cases with no seriousness outcomes as Unknown
                        outcomesData['Unknown / Not Serious']++;
                    }
                });
                
                // Prepare data for chart
                const sortedOutcomes = Object.entries(outcomesData)
                    .filter(([outcome, count]) => count > 0)
                    .sort((a, b) => outcomeCategories[a[0]].order - outcomeCategories[b[0]].order);
                
                const labels = sortedOutcomes.map(([outcome, ]) => outcome);
                const data = sortedOutcomes.map(([, count]) => count);
                const colors = sortedOutcomes.map(([outcome, ]) => outcomeCategories[outcome].color);
                
                const totalCases = filteredData.length;
                
                charts.seriousOutcomes = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Total ADR Cases: ${totalCases.toLocaleString()}`,
                                font: {
                                    size: 14,
                                    weight: 'normal'
                                },
                                padding: 20
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percentage = ((value / totalCases) * 100).toFixed(1);
                                        return [
                                            `Cases: ${value}`,
                                            `${percentage}% of all cases`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Cases'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            y: {
                                ticks: {
                                    autoSkip: false,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }, 100);
        }
        
        function showPatientOutcomes() {
            const contentArea = document.getElementById('content-area');
            
            // Count outcomes using cleanOutcomeValue
            const outcomeOrder = ['Recovered', 'Recovering', 'Recovered with sequelae', 'Not recovered', 'Died', 'Unknown'];
            const outcomeCounts = {};
            const outcomeColors = {
                'Recovered': {
                    background: 'rgba(39, 174, 96, 0.8)',
                    border: 'rgba(39, 174, 96, 1)'
                },
                'Recovering': {
                    background: 'rgba(82, 196, 26, 0.8)',
                    border: 'rgba(82, 196, 26, 1)'
                },
                'Recovered with sequelae': {
                    background: 'rgba(243, 156, 18, 0.8)',
                    border: 'rgba(243, 156, 18, 1)'
                },
                'Not recovered': {
                    background: 'rgba(231, 76, 60, 0.8)',
                    border: 'rgba(231, 76, 60, 1)'
                },
                'Died': {
                    background: 'rgba(44, 62, 80, 0.8)',
                    border: 'rgba(44, 62, 80, 1)'
                },
                'Unknown': {
                    background: 'rgba(149, 165, 166, 0.8)',
                    border: 'rgba(149, 165, 166, 1)'
                }
            };
            
            // Initialize counts
            outcomeOrder.forEach(outcome => {
                outcomeCounts[outcome] = 0;
            });
            
            // Count cleaned outcomes from filtered data
            filteredData.forEach(row => {
                const rawOutcome = row['Outcome (on the date of last follow up)'];
                const cleanedOutcome = cleanOutcomeValue(rawOutcome);
                outcomeCounts[cleanedOutcome]++;
            });
            
            // Calculate total and percentages
            const total = filteredData.length;
            
            // Prepare chart data
            const chartData = {
                labels: [],
                values: [],
                colors: {
                    background: [],
                    border: []
                }
            };
            
            outcomeOrder.forEach(outcome => {
                if (outcomeCounts[outcome] > 0) {
                    chartData.labels.push(outcome);
                    chartData.values.push(outcomeCounts[outcome]);
                    chartData.colors.background.push(outcomeColors[outcome].background);
                    chartData.colors.border.push(outcomeColors[outcome].border);
                }
            });
            
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">ADR Cases by Patient Outcome</h2>
                        <div class="visualization-actions">
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="changeOutcomeView('pie')" id="pieViewBtn">
                                    <i class="fas fa-chart-pie"></i> Pie Chart
                                </button>
                                <button class="btn btn-secondary" onclick="changeOutcomeView('bar')" id="barViewBtn">
                                    <i class="fas fa-chart-bar"></i> Bar Chart
                                </button>
                            </div>
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-value">${total.toLocaleString()}</div>
                            <div class="summary-label">Total Cases</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${outcomeCounts['Recovered'].toLocaleString()}</div>
                            <div class="summary-label">Recovered</div>
                            <div class="summary-percentage">${((outcomeCounts['Recovered'] / total) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${outcomeCounts['Died'].toLocaleString()}</div>
                            <div class="summary-label">Fatal Cases</div>
                            <div class="summary-percentage">${((outcomeCounts['Died'] / total) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${outcomeCounts['Unknown'].toLocaleString()}</div>
                            <div class="summary-label">Unknown Outcome</div>
                            <div class="summary-percentage">${((outcomeCounts['Unknown'] / total) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="outcomeChart"></canvas>
                    </div>
                    
                    <div class="data-quality-section">
                        <h3>Data Quality Notes</h3>
                        <ul>
                            <li>Total records analyzed: ${total.toLocaleString()}</li>
                            <li>Outcomes are standardized from various reporting formats</li>
                            <li>"Unknown" includes blank, unspecified, or unrecognized values</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Create the initial pie chart
            const ctx = document.getElementById('outcomeChart').getContext('2d');
            window.outcomeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: chartData.colors.background,
                        borderColor: chartData.colors.border,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: ${data.datasets[0].data[i].toLocaleString()} (${((data.datasets[0].data[i] / total) * 100).toFixed(1)}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        lineWidth: 2,
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Store chart data globally for view switching
            window.outcomeChartData = chartData;
            window.outcomeTotal = total;
        }
        
        // Function to switch between pie and bar chart views for outcomes
        function changeOutcomeView(viewType) {
            if (!window.outcomeChart || !window.outcomeChartData) return;
            
            const chartData = window.outcomeChartData;
            const total = window.outcomeTotal;
            
            // Update button states
            document.getElementById('pieViewBtn').className = viewType === 'pie' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('barViewBtn').className = viewType === 'bar' ? 'btn btn-primary' : 'btn btn-secondary';
            
            // Destroy existing chart
            window.outcomeChart.destroy();
            
            // Create new chart
            const ctx = document.getElementById('outcomeChart').getContext('2d');
            
            if (viewType === 'pie') {
                window.outcomeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.values,
                            backgroundColor: chartData.colors.background,
                            borderColor: chartData.colors.border,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        return data.labels.map((label, i) => ({
                                            text: `${label}: ${data.datasets[0].data[i].toLocaleString()} (${((data.datasets[0].data[i] / total) * 100).toFixed(1)}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            strokeStyle: data.datasets[0].borderColor[i],
                                            lineWidth: 2,
                                            hidden: false,
                                            index: i
                                        }));
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                window.outcomeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Number of Cases',
                            data: chartData.values,
                            backgroundColor: chartData.colors.background,
                            borderColor: chartData.colors.border,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `Cases: ${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function showDrugAnalysis(type) {
            showVisualizationPlaceholder(`Drug Analysis - ${type === 'who' ? 'WHO Names' : 'Reported Names'}`);
        }
        
        function showPregnancyStatus() {
            showVisualizationPlaceholder('Pregnancy Status');
        }
        
        function showLactationStatus() {
            showVisualizationPlaceholder('Lactation Status');
        }
        
        function showReporterQualification() {
            showVisualizationPlaceholder('Reporter Qualification');
        }
        
        function showReporterOrganization() {
            showVisualizationPlaceholder('Reporter Organization');
        }
        
        function showActionTaken() {
            showVisualizationPlaceholder('Action Taken');
        }
        
        function showGeographic(type) {
            showVisualizationPlaceholder(`Geographic Analysis - ${type === 'district' ? 'District' : 'State/Province'}`);
        }
        
        function showVisualizationPlaceholder(title) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="visualization-content">
                    <div class="visualization-header">
                        <h2 class="visualization-title">${title}</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-secondary" onclick="showExportModal()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 100px 20px; color: #6c757d;">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>This visualization would display ${title} data based on the existing individual visualization files.</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>